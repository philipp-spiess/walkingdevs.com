---
interface Props {
  audioUrl: string
  duration: string
  peaks: number[]
}

const { audioUrl, duration, peaks } = Astro.props
const playerId = `player-${Math.random().toString(36).slice(2, 9)}`
---

<div
  class="audio-player mb-8"
  data-player-id={playerId}
  data-peaks={JSON.stringify(peaks)}
>
  <div class="flex items-center gap-4">
    <!-- Play button and speed control -->
    <div class="shrink-0 flex flex-col items-center gap-1">
      <button
        class="play-btn w-12 h-12 flex items-center justify-center bg-neutral-900 dark:bg-neutral-100 text-white dark:text-neutral-900 rounded-full hover:bg-neutral-800 dark:hover:bg-neutral-200 transition-colors"
        aria-label="Play episode"
      >
        <svg class="play-icon w-5 h-5 ml-0.5" viewBox="0 0 24 24" fill="currentColor">
          <path d="M8 5v14l11-7z"></path>
        </svg>
        <svg class="pause-icon w-5 h-5 hidden" viewBox="0 0 24 24" fill="currentColor">
          <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path>
        </svg>
      </button>
      <button
        class="speed-btn text-xs text-neutral-500 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-neutral-100 font-medium transition-colors"
        aria-label="Change playback speed"
      >
        1x
      </button>
    </div>

    <!-- Waveform and time -->
    <div class="flex-1 min-w-0">
      <audio id={`audio-${playerId}`} preload="metadata" class="hidden">
        <source src={audioUrl} type="audio/mpeg" />
      </audio>

      <div id={playerId} class="waveform h-12"></div>

      <div class="flex justify-between text-xs text-neutral-500 dark:text-neutral-400 mt-1">
        <span class="time-current">0:00</span>
        <span class="time-total">{duration}</span>
      </div>
    </div>
  </div>
</div>

<script>
  import WaveSurfer from 'wavesurfer.js'

  const SPEEDS = [1, 1.25, 1.5, 2]

  function formatTime(seconds: number): string {
    if (!seconds || isNaN(seconds)) return '0:00'
    const mins = Math.floor(seconds / 60)
    const secs = Math.floor(seconds % 60)
    return `${mins}:${secs.toString().padStart(2, '0')}`
  }

  function initPlayer(container: Element) {
    const playerId = container.getAttribute('data-player-id')
    const peaksJson = container.getAttribute('data-peaks')
    const waveformEl = container.querySelector('.waveform') as HTMLElement
    const audioEl = container.querySelector('audio') as HTMLAudioElement

    if (!playerId || !waveformEl || !audioEl || !peaksJson) return

    const peaks = JSON.parse(peaksJson) as number[]

    const playBtn = container.querySelector('.play-btn')
    const playIcon = container.querySelector('.play-icon')
    const pauseIcon = container.querySelector('.pause-icon')
    const speedBtn = container.querySelector('.speed-btn')
    const timeCurrent = container.querySelector('.time-current')
    const timeTotal = container.querySelector('.time-total')

    let currentSpeedIndex = 0

    const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches

    const wavesurfer = WaveSurfer.create({
      container: waveformEl,
      waveColor: isDark ? '#525252' : '#d4d4d4',
      progressColor: isDark ? '#e5e5e5' : '#262626',
      height: 48,
      barWidth: 3,
      barGap: 2,
      barRadius: 2,
      cursorWidth: 1,
      cursorColor: isDark ? '#e5e5e5' : '#262626',
      media: audioEl,
      peaks: [peaks],
    })

    // Update colors when color scheme changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
      const dark = e.matches
      wavesurfer.setOptions({
        waveColor: dark ? '#525252' : '#d4d4d4',
        progressColor: dark ? '#e5e5e5' : '#262626',
        cursorColor: dark ? '#e5e5e5' : '#262626',
      })
    })

    wavesurfer.on('ready', () => {
      const dur = wavesurfer.getDuration()
      if (timeTotal && dur) timeTotal.textContent = formatTime(dur)
    })

    if (playBtn) {
      playBtn.addEventListener('click', () => {
        wavesurfer.playPause()
      })
    }

    if (speedBtn) {
      speedBtn.addEventListener('click', () => {
        currentSpeedIndex = (currentSpeedIndex + 1) % SPEEDS.length
        const newSpeed = SPEEDS[currentSpeedIndex]
        wavesurfer.setPlaybackRate(newSpeed)
        speedBtn.textContent = newSpeed === 1 ? '1x' : `${newSpeed}x`
      })
    }

    wavesurfer.on('play', () => {
      playIcon?.classList.add('hidden')
      pauseIcon?.classList.remove('hidden')
    })

    wavesurfer.on('pause', () => {
      playIcon?.classList.remove('hidden')
      pauseIcon?.classList.add('hidden')
    })

    wavesurfer.on('timeupdate', (currentTime) => {
      if (timeCurrent) {
        timeCurrent.textContent = formatTime(currentTime)
      }
    })

    wavesurfer.on('interaction', () => {
      wavesurfer.play()
    })
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.audio-player').forEach(initPlayer)
    })
  } else {
    document.querySelectorAll('.audio-player').forEach(initPlayer)
  }
</script>
