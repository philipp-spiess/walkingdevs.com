---
import BaseLayout from '../layouts/BaseLayout.astro'
import AudioPlayer from '../components/AudioPlayer.astro'
import PodcastLinks from '../components/PodcastLinks.astro'
import Hosts from '../components/Hosts.astro'
import { fetchPodcastData } from '../lib/rss'
import { generatePeaks } from '../lib/waveform'
import { format } from 'date-fns'

export async function getStaticPaths() {
  const podcast = await fetchPodcastData()

  return podcast.episodes.map((episode) => ({
    params: { slug: episode.slug },
    props: { episode, podcast },
  }))
}

const { episode, podcast } = Astro.props
const formattedDate = format(episode.publishedAt, 'MMMM d, yyyy')
const episodeNumber = episode.episodeNumber.toString().padStart(3, '0')
const peaks = generatePeaks(episode.slug)
---

<BaseLayout
  title={`${episodeNumber}: ${episode.title} - ${podcast.title}`}
  description={episode.description}
  ogImage={`/og/${episode.slug}.png`}
>
  <main class="max-w-2xl mx-auto px-4 py-8 sm:py-12">
    <nav class="mb-6 sm:mb-8">
      <a href="/" class="inline-flex items-center gap-2 text-sm text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-neutral-100">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7"></path>
        </svg>
        All Episodes
      </a>
    </nav>

    <article class="space-y-8">
      <header class="flex items-start gap-4 sm:gap-6">
        <div class="relative shrink-0">
          <img
            src={podcast.coverUrl}
            alt={podcast.title}
            class="w-20 h-20 sm:w-[120px] sm:h-[120px] rounded-lg"
            width="120"
            height="120"
          />
          <div class="absolute inset-0 rounded-lg ring-1 ring-inset ring-black/10 dark:ring-white/10"></div>
        </div>
        <div class="min-w-0">
          <time datetime={episode.publishedAt.toISOString()} class="text-sm text-neutral-500 dark:text-neutral-400">
            {formattedDate}
          </time>
          <h1 class="text-xl sm:text-2xl font-bold mt-1">
            {episodeNumber}: {episode.title}
          </h1>
          <div class="mt-3">
            <PodcastLinks iconOnly />
          </div>
        </div>
      </header>

      <AudioPlayer
        audioUrl={episode.audioUrl}
        duration={episode.duration}
        peaks={peaks}
        slug={episode.slug}
      />

      {
        episode.description && (
          <div class="prose prose-neutral dark:prose-invert max-w-none">
            <p>{episode.description}</p>
          </div>
        )
      }

      <footer class="mt-12 pt-8 border-t border-neutral-200 dark:border-neutral-700">
        <h3 class="text-sm font-medium text-neutral-500 dark:text-neutral-400 mb-4 text-center sm:text-left">Your hosts</h3>
        <Hosts />
      </footer>
    </article>
  </main>
</BaseLayout>
